generator client {
  provider        = "prisma-client-js"
  engineType      = "client"
  previewFeatures = ["postgresqlExtensions", "partialIndexes"]
}

datasource db {
  provider   = "postgresql"
  extensions = [citext, postgis, uuid_ossp(map: "uuid-ossp", schema: "public")]
}

model User {
  id                String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email             String                @unique @db.Citext
  passwordHash      String                @map("password_hash")
  role              Role
  isActive          Boolean?              @default(true) @map("is_active")
  aadhaarEncrypted  String?               @map("aadhaar_encrypted")
  aadhaarHash       String?               @map("aadhaar_hash")
  createdAt         DateTime?             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime?             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt         DateTime?             @map("deleted_at") @db.Timestamptz(6)
  citizenProfile    CitizenProfile?
  assignments       ComplaintAssignment[]
  escalationsFrom   ComplaintEscalation[] @relation("EscalatedFrom")
  escalationsTo     ComplaintEscalation[] @relation("EscalatedTo")
  complaintsCreated Complaint[]           @relation("CreatedComplaints")
  officerProfile    OfficerProfile?

  @@index([id], map: "idx_users_active", where: raw("((deleted_at IS NULL) AND (is_active = true))"))
  @@map("users")
}

model CitizenProfile {
  userId    String    @id @map("user_id") @db.Uuid
  fullName  String    @map("full_name")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("citizen_profile")
}

model District {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  wards     Ward[]

  @@index([name], map: "idx_district_name")
  @@map("districts")
}

model Ward {
  id         String                   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  districtId String                   @map("district_id") @db.Uuid
  name       String
  population Int?                     @default(0)
  boundary   Unsupported("geometry")?
  createdAt  DateTime?                @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt  DateTime?                @map("deleted_at") @db.Timestamptz(6)
  alerts     Alert[]
  complaints Complaint[]
  officers   OfficerProfile[]
  metrics    WardDailyMetric[]
  district   District                 @relation(fields: [districtId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([districtId], map: "idx_ward_district")
  @@index([name], map: "idx_ward_name")
  @@index([boundary], map: "idx_wards_boundary_gist", type: Gist)
  @@map("wards")
}

model OfficerProfile {
  userId      String    @id @map("user_id") @db.Uuid
  wardId      String    @map("ward_id") @db.Uuid
  designation String
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ward        Ward      @relation(fields: [wardId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("officer_profile")
}

model Department {
  id             String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name           String
  description    String?
  departmentType DepartmentType      @map("department_type")
  scope          String              @default("WARD")
  isActive       Boolean?            @default(true) @map("is_active")
  createdAt      DateTime?           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime?           @map("deleted_at") @db.Timestamptz(6)
  categories     ComplaintCategory[]

  @@index([id], map: "idx_departments_active", where: raw("((deleted_at IS NULL) AND (is_active = true))"))
  @@map("departments")
}

model ComplaintCategory {
  id           String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name         String
  departmentId String      @map("department_id") @db.Uuid
  createdAt    DateTime?   @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt    DateTime?   @map("deleted_at") @db.Timestamptz(6)
  department   Department  @relation(fields: [departmentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  complaints   Complaint[]

  @@index([departmentId], map: "idx_category_department")
  @@map("complaint_categories")
}

model Complaint {
  id                  String                   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  citizenId           String                   @map("citizen_id") @db.Uuid
  wardId              String                   @map("ward_id") @db.Uuid
  categoryId          String                   @map("category_id") @db.Uuid
  title               String
  descriptionRaw      String                   @map("description_raw")
  address             String?
  geoPoint            Unsupported("geometry")? @map("geo_point")
  urgencyLevel        UrgencyLevel?            @default(MEDIUM) @map("urgency_level")
  corruptionFlag      Boolean?                 @default(false) @map("corruption_flag")
  anonymousFlag       Boolean?                 @default(false) @map("anonymous_flag")
  currentStatus       ComplaintStatus?         @default(PENDING) @map("current_status")
  lastStatusChangedAt DateTime?                @default(now()) @map("last_status_changed_at") @db.Timestamptz(6)
  createdAt           DateTime?                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime?                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt           DateTime?                @map("deleted_at") @db.Timestamptz(6)
  assignments         ComplaintAssignment[]
  escalations         ComplaintEscalation[]
  category            ComplaintCategory        @relation(fields: [categoryId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  citizen             User                     @relation("CreatedComplaints", fields: [citizenId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ward                Ward                     @relation(fields: [wardId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([geoPoint], map: "idx_complaints_geo_gist", type: Gist)
  @@index([id], map: "idx_complaints_active", where: raw("(deleted_at IS NULL)"))
  @@index([wardId, currentStatus], map: "idx_complaints_ward_status")
  @@index([currentStatus, createdAt(sort: Desc)], map: "idx_complaints_status_date", where: raw("(deleted_at IS NULL)"))
  @@map("complaints")
}

model ComplaintAssignment {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  complaintId  String    @map("complaint_id") @db.Uuid
  officerId    String    @map("officer_id") @db.Uuid
  assignedAt   DateTime  @default(now()) @map("assigned_at") @db.Timestamptz(6)
  unassignedAt DateTime? @map("unassigned_at") @db.Timestamptz(6)
  isActive     Boolean?  @default(true) @map("active")
  complaint    Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  officer      User      @relation(fields: [officerId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("complaint_assignments")
}

model ComplaintEscalation {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  complaintId   String    @map("complaint_id") @db.Uuid
  escalatedFrom String    @map("escalated_from") @db.Uuid
  escalatedTo   String    @map("escalated_to") @db.Uuid
  reason        String
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  complaint     Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  fromUser      User      @relation("EscalatedFrom", fields: [escalatedFrom], references: [id], onDelete: NoAction, onUpdate: NoAction)
  toUser        User      @relation("EscalatedTo", fields: [escalatedTo], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("complaint_escalations")
}

model WardDailyMetric {
  id                     String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  wardId                 String    @map("ward_id") @db.Uuid
  metricDate             DateTime  @map("metric_date") @db.Date
  totalComplaints        Int?      @default(0) @map("total_complaints")
  resolvedCount          Int?      @default(0) @map("resolved_count")
  avgResolutionTimeHours Decimal?  @map("avg_resolution_time_hours") @db.Decimal
  createdAt              DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  ward                   Ward      @relation(fields: [wardId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([wardId, metricDate])
  @@map("ward_daily_metrics")
}

model Alert {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  wardId         String    @map("ward_id") @db.Uuid
  alertType      AlertType @map("alert_type")
  referenceDate  DateTime  @map("reference_date") @db.Date
  metricValue    Decimal   @map("metric_value") @db.Decimal
  thresholdValue Decimal   @map("threshold_value") @db.Decimal
  resolved       Boolean?  @default(false)
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)
  ward           Ward      @relation(fields: [wardId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([wardId, alertType, referenceDate])
  @@map("alerts")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum Role {
  CITIZEN
  OFFICER
  ADMIN

  @@map("user_role")
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("urgency_level")
}

enum ComplaintStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
  CLOSED

  @@map("complaint_status")
}

enum AlertType {
  COMPLAINT_SPIKE
  LOW_RESOLUTION_RATE
  HIGH_AVG_RESOLUTION_TIME

  @@map("alert_type")
}

enum DepartmentType {
  INFRASTRUCTURE
  SANITATION
  WATER_SUPPLY
  ELECTRICITY
  HEALTH
  TRANSPORT
  REVENUE
  GENERAL_ADMIN

  @@map("department_type")
}
